<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Dashboard del Administrador</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin_dashboard.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/header.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<header class="admin-header">
    <div class="header-left">
        <h1>ðŸ“Š Dashboard del Administrador</h1>
    </div>
    <div class="header-right">
        <span>{{ current_user.nombre }}</span>
        <a href="{{ url_for('nom.panel_admin') }}" class="btn-volver">â†© Volver al panel</a>
    </div>
</header>

<main class="dashboard-container">

    <!-- ðŸ”¹ Filtro de mes -->
    <div class="card-filtro-mes">
        <form id="form-filtro-dashboard">
            <label for="mes-dashboard" class="label-filtro">ðŸ“… Selecciona el mes a consultar:</label>
            <div class="select-wrapper">
                <select id="mes-dashboard" name="mes-dashboard">
                    {% for evento in eventos %}
                        <option value="{{ evento.nombre_mes }}" {% if evento.nombre_mes == mes_seleccionado %}selected{% endif %}>
                            {{ evento.nombre_mes }}{% if not evento.esta_abierto_mes %} (cerrado){% endif %}
                        </option>
                    {% endfor %}
                </select>
            </div>
        </form>
    </div>

    <!-- KPIs principales -->
    <section class="kpis">
        <div class="card">
            <h3>Maestros</h3>
            <div id="k_maestros">â€“</div>
        </div>
        <div class="card">
            <h3>Alumnos</h3>
            <div id="k_alumnos">â€“</div>
        </div>
        <div class="card">
            <h3>Nominaciones</h3>
            <div id="k_nominaciones">â€“</div>
        </div>
    </section>

    <!-- GrÃ¡ficas -->
    <section class="charts">
        <div class="chart-box">
            <canvas id="chart_tipo"></canvas>
        </div>
        <div class="chart-box">
            <canvas id="chart_valor"></canvas>
        </div>
        <div class="chart-box full-width">
            <canvas id="chart_dia"></canvas>
        </div>
    </section>
</main>

<script>
let chartTipo = null;
let chartValor = null;
let chartDia = null;

// ðŸ”¢ AnimaciÃ³n de contador para KPIs
function animateCounter(element, start, end, duration = 800) {
    const startTime = performance.now();
    function update(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        const value = Math.floor(start + (end - start) * progress);
        element.textContent = value;
        if (progress < 1) requestAnimationFrame(update);
    }
    requestAnimationFrame(update);
}

async function cargarDashboard(mes = null) {
    try {
        const url = mes ? `/admin/dashboard/data/resumen?mes=${mes}` : '/admin/dashboard/data/resumen';
        const res = await fetch(url);
        const data = await res.json();

        if (data.error) {
            alert(data.error);
            return;
        }

        // === Actualizar KPIs con animaciÃ³n ===
        animateCounter(document.getElementById('k_maestros'),
            parseInt(document.getElementById('k_maestros').textContent) || 0,
            data.totales.maestros);
        animateCounter(document.getElementById('k_alumnos'),
            parseInt(document.getElementById('k_alumnos').textContent) || 0,
            data.totales.alumnos);
        animateCounter(document.getElementById('k_nominaciones'),
            parseInt(document.getElementById('k_nominaciones').textContent) || 0,
            data.totales.nominaciones);

        // === Destruir grÃ¡ficas previas si existen ===
        if (chartTipo) chartTipo.destroy();
        if (chartValor) chartValor.destroy();
        if (chartDia) chartDia.destroy();

        // === GrÃ¡fica 1: Nominaciones por tipo ===
        const ctxTipo = document.getElementById('chart_tipo').getContext('2d');
        chartTipo = new Chart(ctxTipo, {
            type: 'doughnut',
            data: {
                labels: Object.keys(data.por_tipo || {}),
                datasets: [{
                    data: Object.values(data.por_tipo || {}),
                    backgroundColor: ['#1976d2', '#ec407a'],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                animation: { duration: 800, easing: 'easeOutQuart' },
                plugins: {
                    title: {
                        display: true,
                        text: 'Nominaciones por tipo',
                        font: { size: 16, weight: 'bold' }
                    },
                    legend: {
                        position: 'bottom'
                    }
                },
                responsive: true,
                maintainAspectRatio: false
            }
        });

        // === GrÃ¡fica 2: Top valores nominados ===
        const ctxValor = document.getElementById('chart_valor').getContext('2d');
        chartValor = new Chart(ctxValor, {
            type: 'bar',
            data: {
                labels: data.por_valor.map(d => d.valor),
                datasets: [{
                    data: data.por_valor.map(d => d.n),
                    backgroundColor: '#42a5f5',
                    borderRadius: 6
                }]
            },
            options: {
                animation: { duration: 800, easing: 'easeOutQuart' },
                plugins: {
                    title: {
                        display: true,
                        text: 'Top valores nominados',
                        font: { size: 16, weight: 'bold' }
                    },
                    legend: { display: false }
                },
                scales: {
                    y: { beginAtZero: true, ticks: { stepSize: 1 } }
                },
                responsive: true,
                maintainAspectRatio: false
            }
        });

        // === GrÃ¡fica 3: Nominaciones por dÃ­a ===
        const ctxDia = document.getElementById('chart_dia').getContext('2d');
        chartDia = new Chart(ctxDia, {
            type: 'line',
            data: {
                labels: data.por_dia.map(d => d.fecha),
                datasets: [{
                    data: data.por_dia.map(d => d.n),
                    label: 'Nominaciones',
                    borderColor: '#7b0000',
                    backgroundColor: 'rgba(123,0,0,0.1)',
                    tension: 0.4,
                    fill: true,
                    pointRadius: 4,
                    pointBackgroundColor: '#7b0000'
                }]
            },
            options: {
                animation: { duration: 900, easing: 'easeOutQuart' },
                plugins: {
                    title: {
                        display: true,
                        text: 'Nominaciones por dÃ­a',
                        font: { size: 16, weight: 'bold' }
                    },
                    legend: { display: false }
                },
                responsive: true,
                maintainAspectRatio: false
            }
        });

    } catch (err) {
        console.error("Error cargando dashboard:", err);
    }
}

// ðŸŸ¢ Cargar por defecto al entrar
document.addEventListener('DOMContentLoaded', () => {
    const mesInicial = document.getElementById('mes-dashboard')?.value;
    cargarDashboard(mesInicial);

    // ðŸ”„ Detectar cambio de mes
    const selectMes = document.getElementById('mes-dashboard');
    if (selectMes) {
        selectMes.addEventListener('change', () => {
            const nuevoMes = selectMes.value;
            cargarDashboard(nuevoMes);
        });
    }
});
</script>

</body>
</html>
