<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Dashboard del Administrador</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/header.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin_dashboard.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<header class="admin-header">
    <div class="header-left">
        <h1>üìä Dashboard del Administrador</h1>
    </div>
    <div class="header-right">
        <span>{{ current_user.nombre }}</span>
        <a href="{{ url_for('nom.panel_admin') }}" class="btn-volver">‚Ü© Volver al panel</a>
    </div>
</header>

<main class="dashboard-container">

    <!-- üîπ Filtro de mes -->
    <div class="card-filtro-mes">
        <form id="form-filtro-dashboard">
            <label for="mes-dashboard" class="label-filtro">üìÖ Selecciona el mes a consultar:</label>
            <div class="select-wrapper">
                <select id="mes-dashboard" name="mes-dashboard">
                    {% for evento in eventos %}
                        <option value="{{ evento.nombre_mes }}" {% if evento.nombre_mes == mes_seleccionado %}selected{% endif %}>
                            {{ evento.nombre_mes }}{% if not evento.esta_abierto_mes %} (cerrado){% endif %}
                        </option>
                    {% endfor %}
                </select>
            </div>
        </form>
    </div>

    <!-- üü¢ T√≠tulo din√°mico -->
    <h2 id="titulo-mes" class="titulo-mes">{{ mes_seleccionado }}</h2>

    <!-- KPIs -->
    <section class="kpis">
        <div class="card"><h3>Maestros</h3><div id="k_maestros">‚Äì</div></div>
        <div class="card"><h3>Alumnos</h3><div id="k_alumnos">‚Äì</div></div>
        <div class="card"><h3>Nominaciones</h3><div id="k_nominaciones">‚Äì</div></div>
    </section>

    <!-- Gr√°ficas -->
    <section class="charts">
        <div class="chart-box"><canvas id="chart_tipo"></canvas></div>
        <div class="chart-box"><canvas id="chart_valor"></canvas></div>
        <div class="chart-box full-width"><canvas id="chart_dia"></canvas></div>
    </section>

    <!-- üì© Exportar nominaciones -->
    <section class="export-section">

    <div class="exportar-concentrado">
        <h3>üìä Exportar concentrado general</h3>
        <button class="btn-exportar" id="btnExportarExcel">üì• Descargar Excel</button>
    </div>

    <div class="exportar-bloques">
        <h3>üì¶ Exportar invitaciones por bloque</h3>

        <label for="bloqueSelect">Bloque:</label>
        <select id="bloqueSelect">
            {% for bloque in bloques %}
                <option value="{{ bloque.id }}">{{ bloque.nombre }}</option>
            {% endfor %}
        </select>

        <button class="btn-exportar" id="btnDescargarBloque">üìÑ Descargar Alumnos</button>

        <button class="btn-exportar azul" id="btnDescargarProfesores">
            üìò Descargar Profesores
        </button>
    </div>

    <h2>üì© Exportar nominaciones por maestro</h2>

    <div class="export-filtros">
        <div class="campo">
            <label for="maestro-search">üîç Buscar maestro:</label>
            <input type="text" id="maestro-search" placeholder="Escribe para filtrar..." class="input-buscar">
        </div>

        <div class="campo">
            <label for="maestro-select">üë®‚Äçüè´ Maestro:</label>
            <select id="maestro-select"></select>
        </div>

        <div class="campo">
            <label for="mes-export">üìÖ Mes:</label>
            <select id="mes-export">
                {% for evento in eventos %}
                    <option value="{{ evento.mes_ordinal }}">{{ evento.nombre_mes }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="botones">
            <button id="btn-buscar-nominaciones" class="btn-accion rojo">üîç Buscar</button>
            <button id="btn-generar-pdf" class="btn-accion verde" disabled>üìÑ Generar Words seleccionados</button>
        </div>
    </div>

    <table id="tabla-nominaciones" class="tabla-dashboard">
        <thead>
            <tr>
                <th><input type="checkbox" id="select-all"></th>
                <th>Fecha</th>
                <th>Tipo</th>
                <th>Nominado</th>
                <th>Bloque</th>
                <th>Valor</th>
                <th>Comentario</th>
                <th>Evento</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

</section>
</main>

<!-- üîÑ Overlay visual -->
<div id="overlay-cargando" style="
    display:none;
    position:fixed;
    top:0;left:0;width:100%;height:100%;
    background:rgba(0,0,0,0.5);
    color:white;
    font-size:1.5em;
    justify-content:center;
    align-items:center;
    z-index:9999;">
    ‚è≥ Generando invitaciones, por favor espera...
</div>

<!-- üÜï NUEVO: Modal para selecci√≥n de lote -->
<div id="modal-lotes" class="modal" style="
    display:none;
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.5);
    justify-content:center;
    align-items:center;
    z-index:99999;">
        
    <div class="modal-content" style="
        background:white;
        padding:20px;
        border-radius:10px;
        width:300px;
        text-align:center;">
        
        <h3>Selecciona el lote</h3>
        <p id="modal-info">Cargando‚Ä¶</p>

        <div id="modal-lotes-buttons" style="margin-top:10px;"></div>

        <button onclick="cerrarModal()" class="btn-accion rojo" style="margin-top:15px;">Cancelar</button>
    </div>
</div>

<script>
// ===============================
// üîπ URLs seguras
// ===============================
const URL_LISTAR = "{{ url_for('admin_bp.nominaciones_por_maestro_y_mes') }}";
const URL_GENERAR = "{{ url_for('nom.generar_invitaciones_stream') }}";

let chartTipo=null, chartValor=null, chartDia=null;

// ===============================
// üîπ Utilidades
// ===============================
function animateCounter(el,start,end,d=800){
    const st=performance.now();
    const up=t=>{
        const p=Math.min((t-st)/d,1);
        el.textContent=Math.floor(start+(end-start)*p);
        if(p<1)requestAnimationFrame(up);
    };
    requestAnimationFrame(up);
}

function actualizarTituloMes(m){
    const t=document.getElementById('titulo-mes');
    t.textContent=m;
    t.classList.add('animado');
    setTimeout(()=>t.classList.remove('animado'),600);
}

function mostrarOverlay(mostrar=true){
    document.getElementById("overlay-cargando").style.display=mostrar?"flex":"none";
}

// ===============================
// üîπ Dashboard principal
// ===============================
async function cargarDashboard(mes=null){
    try{
        const url=mes?`/admin/dashboard/data/resumen?mes=${mes}`:'/admin/dashboard/data/resumen';
        const res=await fetch(url);
        const data=await res.json();
        if(data.error)return alert(data.error);

        actualizarTituloMes(mes||"Resumen general");
        animateCounter(document.getElementById('k_maestros'),0,data.totales.maestros);
        animateCounter(document.getElementById('k_alumnos'),0,data.totales.alumnos);
        animateCounter(document.getElementById('k_nominaciones'),0,data.totales.nominaciones);

        if(chartTipo)chartTipo.destroy(); 
        if(chartValor)chartValor.destroy(); 
        if(chartDia)chartDia.destroy();

        chartTipo=new Chart(document.getElementById('chart_tipo'),{
            type:'doughnut',
            data:{labels:Object.keys(data.por_tipo||{}),
            datasets:[{data:Object.values(data.por_tipo||{}),backgroundColor:['#1976d2','#ec407a']}]},
            options:{devicePixelRatio:2,plugins:{title:{display:true,text:'Nominaciones por tipo'}}}
        });

        chartValor=new Chart(document.getElementById('chart_valor'),{
            type:'bar',
            data:{
                labels:data.por_valor.map(d=>d.valor),
                datasets:[{
                    label:'VALORES',
                    data:data.por_valor.map(d=>d.n),
                    backgroundColor:'#42a5f5'
                }]
            },
            options:{
                devicePixelRatio:2,
                plugins:{title:{display:true,text:'Top valores nominados'}},
                scales:{y:{beginAtZero:true}}
            }
        });

        function convertirFechaISO(f){
            const [d,m,y]=f.split("/");
            return `${y}-${m}-${d}`;
        }

        const porDiaOrdenado=[...data.por_dia].sort((a,b)=>
            new Date(convertirFechaISO(a.fecha)) - new Date(convertirFechaISO(b.fecha))
        );

        chartDia=new Chart(document.getElementById('chart_dia'),{
            type:'line',
            data:{
                labels:porDiaOrdenado.map(d=>d.fecha),
                datasets:[{
                    data:porDiaOrdenado.map(d=>d.n),
                    label:'Nominaciones',
                    borderColor:'#7b0000',
                    backgroundColor:'rgba(123,0,0,0.1)',
                    tension:0.4,
                    fill:true
                }]
            },
            options:{
                devicePixelRatio:2,
                plugins:{title:{display:true,text:'Nominaciones por d√≠a'}}
            }
        });

    }catch(e){ console.error("Error:",e); }
}

// ===============================
// üîπ Cargar maestros + buscador
// ===============================
async function cargarMaestros(){
    const r=await fetch('/admin/catalogo/maestros');
    const maestros=await r.json();
    const select=document.getElementById('maestro-select');
    const input=document.getElementById('maestro-search');

    select.innerHTML='';
    maestros.forEach(m=>{
        const opt=document.createElement('option');
        opt.value=m.id; opt.textContent=m.nombre;
        select.appendChild(opt);
    });

    input.addEventListener('input',()=>{
        const term=input.value.toLowerCase().trim();
        const filtrados=maestros.filter(m=>m.nombre.toLowerCase().includes(term));
        select.innerHTML='';
        filtrados.forEach(m=>{
            const opt=document.createElement('option');
            opt.value=m.id; opt.textContent=m.nombre;
            select.appendChild(opt);
        });
        if(filtrados.length===1)select.value=filtrados[0].id;
    });
}

// ===============================
// üîπ Buscar nominaciones
// ===============================
async function buscarNominaciones(){
    const maestro=document.getElementById('maestro-select').value;
    const mes=document.getElementById('mes-export').value;
    if(!maestro||!mes)return alert("Selecciona maestro y mes");

    const r=await fetch(`${URL_LISTAR}?maestro_id=${maestro}&mes=${mes}`);
    const data=await r.json();
    const tbody=document.querySelector('#tabla-nominaciones tbody');

    tbody.innerHTML="";
    data.forEach(n=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`
            <td><input type="checkbox" class="chk-nom" value="${n.id}" checked></td>
            <td>${n.fecha}</td>
            <td>${n.tipo}</td>
            <td>${n.nominado}</td>
            <td><span class="chip-bloque">${n.bloque || "‚Äî"}</span></td>
            <td>${n.valor}</td>
            <td>${n.comentario}</td>
            <td>${n.evento}</td>
        `;
        tbody.appendChild(tr);
    });

    document.getElementById('btn-generar-pdf').disabled=data.length===0;
}

document.getElementById('select-all').addEventListener('change',e=>{
    document.querySelectorAll('.chk-nom').forEach(chk=>chk.checked=e.target.checked);
});

// ===============================
// üîπ Exportaci√≥n Excel y Profesores (SIN LOTES)
// ===============================
document.getElementById("btnExportarExcel").addEventListener("click",()=>{
    const mes = document.getElementById("mes-dashboard").value;
    if(!mes) return alert("Selecciona un mes.");
    window.location.href = `/admin/dashboard/exportar_concentrado_excel?mes=${encodeURIComponent(mes)}`;
});

document.getElementById("btnDescargarProfesores").addEventListener("click",async()=>{
    const mes=document.getElementById("mes-dashboard").value;
    if(!mes)return alert("Selecciona un mes.");

    // üÜï Ahora profesores tambi√©n usan LOTES
    await abrirModalProfesores(mes);
});

document.getElementById("btnDescargarBloque").addEventListener("click",async()=>{
    const mes=document.getElementById("mes-dashboard").value;
    const bloque=document.getElementById("bloqueSelect").value;

    if(!mes||!bloque)return alert("Selecciona bloque y mes.");

    await abrirModalAlumnos(bloque,mes);
});

// =====================================================
// üÜï NUEVAS FUNCIONES PARA LOTES (ALUMNOS + PROFESORES)
// =====================================================

function cerrarModal(){
    document.getElementById("modal-lotes").style.display="none";
}

async function abrirModalAlumnos(bloqueId,mes){
    const modal=document.getElementById("modal-lotes");
    const info=document.getElementById("modal-info");
    const cont=document.getElementById("modal-lotes-buttons");

    modal.style.display="flex";
    info.textContent="Calculando lotes‚Ä¶";
    cont.innerHTML="";

    const r=await fetch(`/admin/dashboard/contar_lotes?bloque_id=${bloqueId}&mes=${mes}`);
    const data=await r.json();

    if(data.error)return alert(data.error);

    info.textContent=`Hay ${data.total_lotes} lotes disponibles:`;

    for(let i=1;i<=data.total_lotes;i++){
        const btn=document.createElement("button");
        btn.textContent=`Lote ${i}`;
        btn.className="btn-exportar";
        btn.onclick=()=>{ 
            window.location.href=
            `/admin/dashboard/generar_invitaciones_bloque_unico?bloque_id=${bloqueId}&mes=${mes}&lote=${i}`;
            cerrarModal();
        };
        cont.appendChild(btn);
    }
}

async function abrirModalProfesores(mes){
    const modal=document.getElementById("modal-lotes");
    const info=document.getElementById("modal-info");
    const cont=document.getElementById("modal-lotes-buttons");

    modal.style.display="flex";
    info.textContent="Calculando lotes‚Ä¶";
    cont.innerHTML="";

    const r=await fetch(`/admin/dashboard/contar_lotes_profesores?mes=${mes}`);
    const data=await r.json();

    if(data.error)return alert(data.error);

    info.textContent=`Hay ${data.total_lotes} lotes disponibles:`;

    for(let i=1;i<=data.total_lotes;i++){
        const btn=document.createElement("button");
        btn.textContent=`Lote ${i}`;
        btn.className="btn-exportar azul";
        btn.onclick=()=>{
            window.location.href=
            `/admin/dashboard/generar_invitaciones_profesores?mes=${mes}&lote=${i}`;
            cerrarModal();
        };
        cont.appendChild(btn);
    }
}

// ===============================
// üîπ Generar invitaciones seleccionadas (MAESTROS normales)
// ===============================
async function generarInvitaciones(){
    const seleccionados=[...document.querySelectorAll('.chk-nom:checked')].map(ch=>ch.value);
    if(!seleccionados.length)return alert("Selecciona al menos una nominaci√≥n");

    const total=seleccionados.length;
    const url=`${URL_GENERAR}?ids=${seleccionados.join(",")}`;
    const overlay=document.getElementById("overlay-cargando");

    overlay.innerHTML=`
        <div class="spinner-container">
            <div class="spinner"></div>
            <p id="mensaje-cargando">Generando 1 de ${total} invitaciones...</p>
            <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
            <p id="progress-text">0%</p>
        </div>`;
    overlay.style.display="flex";

    const barra=document.getElementById("progress-fill");
    const texto=document.getElementById("progress-text");
    const msg=document.getElementById("mensaje-cargando");

    let current=0;
    const duration=Math.max(3,total*0.6);

    const interval=setInterval(()=>{
        current++;
        const p=Math.min((current/duration)*100,100);
        barra.style.width=`${p}%`;
        texto.textContent=`${Math.floor(p)}%`;
        msg.textContent=`Generando ${Math.min(Math.ceil((p/100)*total),total)} de ${total} invitaciones...`;
        if(p>=100)clearInterval(interval);
    },600);

    try{
        const a=document.createElement("a");
        a.href=url;
        a.download="";
        document.body.appendChild(a);
        a.click();
        a.remove();

        setTimeout(()=>{
            overlay.innerHTML=`<p style="font-size:1.3em;">‚úÖ Invitaciones listas</p>`;
            setTimeout(()=>overlay.style.display="none",1800);
        },duration*1000+1000);

    }catch(e){
        alert("Error generando invitaciones");
        overlay.style.display="none";
    }
}

// ===============================
// üîπ Inicializaci√≥n
// ===============================
document.addEventListener('DOMContentLoaded',()=>{
    const mesInicial=document.getElementById('mes-dashboard')?.value;
    cargarDashboard(mesInicial);
    cargarMaestros();

    document.getElementById('mes-dashboard').addEventListener('change',
        ()=>cargarDashboard(document.getElementById('mes-dashboard').value)
    );

    document.getElementById('btn-buscar-nominaciones').addEventListener('click',buscarNominaciones);
    document.getElementById('btn-generar-pdf').addEventListener('click',generarInvitaciones);
});
</script>

