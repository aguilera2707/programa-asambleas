<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Dashboard del Administrador</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/header.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin_dashboard.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<header class="admin-header">
    <div class="header-left">
        <h1>ğŸ“Š Dashboard del Administrador</h1>
    </div>
    <div class="header-right">
        <span>{{ current_user.nombre }}</span>
        <a href="{{ url_for('nom.panel_admin') }}" class="btn-volver">â†© Volver al panel</a>
    </div>
</header>

<main class="dashboard-container">

    <!-- ğŸ”¹ Filtro de mes -->
    <div class="card-filtro-mes">
        <form id="form-filtro-dashboard">
            <label for="mes-dashboard" class="label-filtro">ğŸ“… Selecciona el mes a consultar:</label>
            <div class="select-wrapper">
                <select id="mes-dashboard" name="mes-dashboard">
                    {% for evento in eventos %}
                        <option value="{{ evento.nombre_mes }}" {% if evento.nombre_mes == mes_seleccionado %}selected{% endif %}>
                            {{ evento.nombre_mes }}{% if not evento.esta_abierto_mes %} (cerrado){% endif %}
                        </option>
                    {% endfor %}
                </select>
            </div>
        </form>
    </div>

    <!-- ğŸŸ¢ TÃ­tulo dinÃ¡mico -->
    <h2 id="titulo-mes" class="titulo-mes">{{ mes_seleccionado }}</h2>

    <!-- KPIs -->
    <section class="kpis">
        <div class="card"><h3>Maestros</h3><div id="k_maestros">â€“</div></div>
        <div class="card"><h3>Alumnos</h3><div id="k_alumnos">â€“</div></div>
        <div class="card"><h3>Nominaciones</h3><div id="k_nominaciones">â€“</div></div>
    </section>

    <!-- GrÃ¡ficas -->
    <section class="charts">
        <div class="chart-box"><canvas id="chart_tipo"></canvas></div>
        <div class="chart-box"><canvas id="chart_valor"></canvas></div>
        <div class="chart-box full-width"><canvas id="chart_dia"></canvas></div>
    </section>

    <!-- ğŸ“© Exportar nominaciones -->
    <section class="export-section">

    <div class="exportar-concentrado">
    <h3>ğŸ“Š Exportar concentrado general</h3>
    <button class="btn-exportar" id="btnExportarExcel">ğŸ“¥ Descargar Excel</button>
    </div>

    <div class="exportar-bloques">
    <h3>ğŸ“¦ Exportar invitaciones por bloque</h3> 

    <label for="bloqueSelect">Bloque:</label>
    <select id="bloqueSelect">
        {% for bloque in bloques %}
            <option value="{{ bloque.id }}">{{ bloque.nombre }}</option>
        {% endfor %}
    </select>



    <button class="btn-exportar" id="btnDescargarBloque">ğŸ“„ Descargar Alumnos</button>
    <button class="btn-exportar azul" id="btnDescargarProfesores">
        ğŸ“˜ Descargar Profesores
    </button>
    </div>
        <h2>ğŸ“© Exportar nominaciones por maestro</h2>


        <div class="export-filtros">
            <div class="campo">
                <label for="maestro-search">ğŸ” Buscar maestro:</label>
                <input type="text" id="maestro-search" placeholder="Escribe para filtrar..." class="input-buscar">
            </div>

            <div class="campo">
                <label for="maestro-select">ğŸ‘¨â€ğŸ« Maestro:</label>
                <select id="maestro-select"></select>
            </div>

            <div class="campo">
                <label for="mes-export">ğŸ“… Mes:</label>
                <select id="mes-export">
                    {% for evento in eventos %}
                        <option value="{{ evento.mes_ordinal }}">{{ evento.nombre_mes }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="botones">
                <button id="btn-buscar-nominaciones" class="btn-accion rojo">ğŸ” Buscar</button>
                <button id="btn-generar-pdf" class="btn-accion verde" disabled>ğŸ“„ Generar Words seleccionados</button>
            </div>
        </div>

        <table id="tabla-nominaciones" class="tabla-dashboard">
            <thead>
                <tr>
                    <th><input type="checkbox" id="select-all"></th>
                    <th>Fecha</th>
                    <th>Tipo</th>
                    <th>Nominado</th>
                    <th>Bloque</th>
                    <th>Valor</th>
                    <th>Comentario</th>
                    <th>Evento</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </section>
</main>

<!-- ğŸ”„ Overlay visual -->
<div id="overlay-cargando" style="
    display:none;
    position:fixed;
    top:0;left:0;width:100%;height:100%;
    background:rgba(0,0,0,0.5);
    color:white;
    font-size:1.5em;
    justify-content:center;
    align-items:center;
    z-index:9999;
">
    â³ Generando invitaciones, por favor espera...
</div>

<script>
// ===============================
// ğŸ”¹ URLs seguras
// ===============================
const URL_LISTAR = "{{ url_for('admin_bp.nominaciones_por_maestro_y_mes') }}";
const URL_GENERAR = "{{ url_for('nom.generar_invitaciones_stream') }}";

let chartTipo=null, chartValor=null, chartDia=null;

// ===============================
// ğŸ”¹ Utilidades
// ===============================
function animateCounter(el,start,end,d=800){
    const st=performance.now();
    const up=t=>{
        const p=Math.min((t-st)/d,1);
        el.textContent=Math.floor(start+(end-start)*p);
        if(p<1)requestAnimationFrame(up);
    };
    requestAnimationFrame(up);
}

function actualizarTituloMes(m){
    const t=document.getElementById('titulo-mes');
    t.textContent=m;
    t.classList.add('animado');
    setTimeout(()=>t.classList.remove('animado'),600);
}

function mostrarOverlay(mostrar=true){
    document.getElementById("overlay-cargando").style.display=mostrar?"flex":"none";
}



// ===============================
// ğŸ”¹ Dashboard principal
// ===============================
async function cargarDashboard(mes=null){
    try{
        const url=mes?`/admin/dashboard/data/resumen?mes=${mes}`:'/admin/dashboard/data/resumen';
        const res=await fetch(url);
        const data=await res.json();
        if(data.error)return alert(data.error);

        actualizarTituloMes(mes||"Resumen general");
        animateCounter(document.getElementById('k_maestros'),0,data.totales.maestros);
        animateCounter(document.getElementById('k_alumnos'),0,data.totales.alumnos);
        animateCounter(document.getElementById('k_nominaciones'),0,data.totales.nominaciones);

        if(chartTipo)chartTipo.destroy(); if(chartValor)chartValor.destroy(); if(chartDia)chartDia.destroy();

        chartTipo=new Chart(document.getElementById('chart_tipo'),{
            type:'doughnut',
            data:{labels:Object.keys(data.por_tipo||{}),
            datasets:[{data:Object.values(data.por_tipo||{}),backgroundColor:['#1976d2','#ec407a']}]},
            options:{devicePixelRatio:2,plugins:{title:{display:true,text:'Nominaciones por tipo'}}}
        });

        chartValor = new Chart(document.getElementById('chart_valor'), {
            type: 'bar',
            data: {
                labels: data.por_valor.map(d => d.valor),
                datasets: [{
                    label: 'VALORES', // âœ… agrega este label
                    data: data.por_valor.map(d => d.n),
                    backgroundColor: '#42a5f5'
                }]
            },
            options: {
                devicePixelRatio: 2,
                plugins: {
                    title: { display: true, text: 'Top valores nominados' }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    function convertirFechaISO(fecha){
            const [d,m,y] = fecha.split("/");
            return `${y}-${m}-${d}`;
            }

            const porDiaOrdenado = [...data.por_dia].sort((a,b)=> 
                new Date(convertirFechaISO(a.fecha)) - new Date(convertirFechaISO(b.fecha))
            );
        chartDia=new Chart(document.getElementById('chart_dia'),{
            type:'line',
            data:{
                labels:porDiaOrdenado.map(d=>d.fecha),
                datasets:[{
                    data:porDiaOrdenado.map(d=>d.n),
                    label:'Nominaciones',
                    borderColor:'#7b0000',
                    backgroundColor:'rgba(123,0,0,0.1)',
                    tension:0.4,
                    fill:true
                }]
            },
            options:{
                devicePixelRatio:2,
                plugins:{title:{display:true,text:'Nominaciones por dÃ­a'}}
            }
        });
    }catch(e){console.error("Error:",e);}
}

// ===============================
// ğŸ”¹ Cargar maestros + buscador
// ===============================
async function cargarMaestros(){
    const r=await fetch('/admin/catalogo/maestros');
    const maestros=await r.json();
    const select=document.getElementById('maestro-select');
    const input=document.getElementById('maestro-search');

    select.innerHTML='';
    maestros.forEach(m=>{
        const opt=document.createElement('option');
        opt.value=m.id; opt.textContent=m.nombre;
        select.appendChild(opt);
    });

    input.addEventListener('input',()=>{
        const term=input.value.toLowerCase().trim();
        const filtrados=maestros.filter(m=>m.nombre.toLowerCase().includes(term));
        select.innerHTML='';
        filtrados.forEach(m=>{
            const opt=document.createElement('option');
            opt.value=m.id; opt.textContent=m.nombre;
            select.appendChild(opt);
        });
        if(filtrados.length===1)select.value=filtrados[0].id;
    });
}

// ===============================
// ğŸ”¹ Buscar nominaciones
// ===============================
async function buscarNominaciones(){
    const maestro=document.getElementById('maestro-select').value;
    const mes=document.getElementById('mes-export').value;
    if(!maestro||!mes)return alert("Selecciona maestro y mes");

    const r=await fetch(`${URL_LISTAR}?maestro_id=${maestro}&mes=${mes}`);
    const data=await r.json();
    const tbody=document.querySelector('#tabla-nominaciones tbody');
    tbody.innerHTML="";
    data.forEach(n=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`
            <td><input type="checkbox" class="chk-nom" value="${n.id}" checked></td>
            <td>${n.fecha}</td>
            <td>${n.tipo}</td>
            <td>${n.nominado}</td>
            <td><span class="chip-bloque">${n.bloque || "â€”"}</span></td>
            <td>${n.valor}</td>
            <td>${n.comentario}</td>
            <td>${n.evento}</td>
        `;
        tbody.appendChild(tr);
    });
    document.getElementById('btn-generar-pdf').disabled=data.length===0;
}

document.getElementById('select-all').addEventListener('change',e=>{
    document.querySelectorAll('.chk-nom').forEach(chk=>chk.checked=e.target.checked);
});

document.getElementById("btnExportarExcel").addEventListener("click", () => {
    window.location.href = "/admin/dashboard/exportar_concentrado_excel";
});

document.getElementById("btnDescargarProfesores").addEventListener("click", () => {
    const mes = document.getElementById("mes-dashboard").value;

    if (!mes) {
        alert("Selecciona un mes.");
        return;
    }

    window.location.href = `/admin/dashboard/generar_invitaciones_profesores?mes=${mes}`;
});


document.getElementById("btnDescargarBloque").addEventListener("click", () => {
    const bloqueId = document.getElementById("bloqueSelect").value;
    const mes = document.getElementById("mes-dashboard").value;

    if (!bloqueId) {
        alert("Selecciona un bloque primero.");
        return;
    }

    window.location.href = `/admin/dashboard/generar_invitaciones_bloque_unico?bloque_id=${bloqueId}&mes=${mes}`;
});

// ===============================
// ğŸ”¹ Generar invitaciones (nuevo streaming directo)
// ===============================
// ===============================
// ğŸ”¹ Generar invitaciones con progreso visual simulado
// ===============================
async function generarInvitaciones(){
    const seleccionados = [...document.querySelectorAll('.chk-nom:checked')].map(chk => chk.value);
    if(!seleccionados.length) return alert("Selecciona al menos una nominaciÃ³n.");

    const total = seleccionados.length;
    const url = `${URL_GENERAR}?ids=${seleccionados.join(",")}`;
    const overlay = document.getElementById("overlay-cargando");

    // Crear barra de progreso temporal
    overlay.innerHTML = `
        <div class="spinner-container">
            <div class="spinner"></div>
            <p id="mensaje-cargando">Generando 1 de ${total} invitaciones...</p>
            <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
            <p id="progress-text">0%</p>
        </div>
    `;
    overlay.style.display = "flex";

    // SimulaciÃ³n visual del progreso
    const barra = document.getElementById("progress-fill");
    const texto = document.getElementById("progress-text");
    const msg = document.getElementById("mensaje-cargando");

    let current = 0;
    const duration = Math.max(3, total * 0.6); // segundos aprox.
    const interval = setInterval(()=>{
        current++;
        const porcentaje = Math.min((current / duration) * 100, 100);
        barra.style.width = `${porcentaje}%`;
        texto.textContent = `${Math.floor(porcentaje)}%`;
        const invitacionActual = Math.min(Math.ceil((porcentaje / 100) * total), total);
        msg.textContent = `Generando ${invitacionActual} de ${total} invitaciones...`;
        if(porcentaje >= 100){
            clearInterval(interval);
        }
    }, 600);

    try {
        // ğŸ”¸ Crear enlace invisible para descargar el ZIP
        const enlace = document.createElement("a");
        enlace.href = url;
        enlace.download = "";
        document.body.appendChild(enlace);
        enlace.click();
        document.body.removeChild(enlace);

        // ğŸ”¹ Mostrar mensaje final
        setTimeout(()=>{
            overlay.innerHTML = `
                <div class="spinner-container">
                    <p style="font-size:1.3em;">âœ… Invitaciones listas y descargadas</p>
                </div>
            `;
            setTimeout(()=> overlay.style.display = "none", 1800);
        }, (duration * 1000) + 1000);

    } catch (err) {
        console.error("Error generando invitaciones:", err);
        alert("OcurriÃ³ un error al generar las invitaciones.");
        overlay.style.display = "none";
    }
}


// ===============================
// ğŸ”¹ InicializaciÃ³n
// ===============================
document.addEventListener('DOMContentLoaded',()=>{
    const mesInicial=document.getElementById('mes-dashboard')?.value;
    cargarDashboard(mesInicial);
    document.getElementById('mes-dashboard').addEventListener('change',()=>cargarDashboard(document.getElementById('mes-dashboard').value));
    cargarMaestros();
    document.getElementById('btn-buscar-nominaciones').addEventListener('click',buscarNominaciones);
    document.getElementById('btn-generar-pdf').addEventListener('click',generarInvitaciones);
});
</script>

</body>
</html>
