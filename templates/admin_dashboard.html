<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Dashboard del Administrador</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/header.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin_dashboard.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<header class="admin-header">
    <div class="header-left">
        <h1>📊 Dashboard del Administrador</h1>
    </div>
    <div class="header-right">
        <span>{{ current_user.nombre }}</span>
        <a href="{{ url_for('nom.panel_admin') }}" class="btn-volver">↩ Volver al panel</a>
    </div>
</header>

<main class="dashboard-container">

    <!-- 🔹 Filtro de mes -->
    <div class="card-filtro-mes">
        <form id="form-filtro-dashboard">
            <label for="mes-dashboard" class="label-filtro">📅 Selecciona el mes a consultar:</label>
            <div class="select-wrapper">
                <select id="mes-dashboard" name="mes-dashboard">
                    {% for evento in eventos %}
                        <option value="{{ evento.nombre_mes }}" {% if evento.nombre_mes == mes_seleccionado %}selected{% endif %}>
                            {{ evento.nombre_mes }}{% if not evento.esta_abierto_mes %} (cerrado){% endif %}
                        </option>
                    {% endfor %}
                </select>
            </div>
        </form>
    </div>

    <!-- 🟢 Título dinámico -->
    <h2 id="titulo-mes" class="titulo-mes">{{ mes_seleccionado }}</h2>

    <!-- KPIs -->
    <section class="kpis">
        <div class="card"><h3>Maestros</h3><div id="k_maestros">–</div></div>
        <div class="card"><h3>Alumnos</h3><div id="k_alumnos">–</div></div>
        <div class="card"><h3>Nominaciones</h3><div id="k_nominaciones">–</div></div>
    </section>

    <!-- Gráficas -->
    <section class="charts">
        <div class="chart-box"><canvas id="chart_tipo"></canvas></div>
        <div class="chart-box"><canvas id="chart_valor"></canvas></div>
        <div class="chart-box full-width"><canvas id="chart_dia"></canvas></div>
    </section>

    <!-- 📩 Exportar nominaciones -->
    <section class="export-section">
        <h2>📩 Exportar nominaciones por maestro</h2>

        <div class="export-filtros">
            <div class="campo">
                <label for="maestro-search">🔍 Buscar maestro:</label>
                <input type="text" id="maestro-search" placeholder="Escribe para filtrar..." class="input-buscar">
            </div>

            <div class="campo">
                <label for="maestro-select">👨‍🏫 Maestro:</label>
                <select id="maestro-select"></select>
            </div>

            <div class="campo">
                <label for="mes-export">📅 Mes:</label>
                <select id="mes-export">
                    {% for evento in eventos %}
                        <option value="{{ evento.mes_ordinal }}">{{ evento.nombre_mes }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="botones">
                <button id="btn-buscar-nominaciones" class="btn-accion rojo">🔍 Buscar</button>
                <button id="btn-generar-pdf" class="btn-accion verde" disabled>📄 Generar PDFs seleccionados</button>
            </div>
        </div>

        <table id="tabla-nominaciones" class="tabla-dashboard">
            <thead>
                <tr>
                    <th><input type="checkbox" id="select-all"></th>
                    <th>Fecha</th>
                    <th>Tipo</th>
                    <th>Nominado</th>
                    <th>Bloque</th>
                    <th>Valor</th>
                    <th>Comentario</th>
                    <th>Evento</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </section>
</main>

<!-- 🔄 Overlay con barra de progreso -->
<div id="overlay-cargando">
    <div class="spinner-container">
        <div class="spinner"></div>
        <p id="mensaje-cargando">Generando PDFs, por favor espera...</p>
        <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
        <p id="progress-text">0%</p>
    </div>
</div>

<script>
// ===============================
// 🔹 URLs seguras
// ===============================
const URL_LISTAR = "{{ url_for('admin_bp.nominaciones_por_maestro_y_mes') }}";
const URL_GENERAR = "{{ url_for('nom.generar_invitaciones_stream') }}";

let chartTipo=null, chartValor=null, chartDia=null;

// ===============================
// 🔹 Utilidades
// ===============================
function animateCounter(el,start,end,d=800){
    const st=performance.now();
    const up=t=>{
        const p=Math.min((t-st)/d,1);
        el.textContent=Math.floor(start+(end-start)*p);
        if(p<1)requestAnimationFrame(up);
    };
    requestAnimationFrame(up);
}

function actualizarTituloMes(m){
    const t=document.getElementById('titulo-mes');
    t.textContent=m;
    t.classList.add('animado');
    setTimeout(()=>t.classList.remove('animado'),600);
}

function mostrarCargando(mostrar=true,mensaje="Generando invitaciones..."){
    const o=document.getElementById("overlay-cargando");
    const texto=document.getElementById("mensaje-cargando");
    texto.textContent=mensaje;
    o.style.display=mostrar?"flex":"none";
}

// ===============================
// 🔹 Dashboard principal
// ===============================
async function cargarDashboard(mes=null){
    try{
        const url=mes?`/admin/dashboard/data/resumen?mes=${mes}`:'/admin/dashboard/data/resumen';
        const res=await fetch(url);
        const data=await res.json();
        if(data.error)return alert(data.error);

        actualizarTituloMes(mes||"Resumen general");
        animateCounter(document.getElementById('k_maestros'),0,data.totales.maestros);
        animateCounter(document.getElementById('k_alumnos'),0,data.totales.alumnos);
        animateCounter(document.getElementById('k_nominaciones'),0,data.totales.nominaciones);

        if(chartTipo)chartTipo.destroy(); if(chartValor)chartValor.destroy(); if(chartDia)chartDia.destroy();

        chartTipo=new Chart(document.getElementById('chart_tipo'),{
            type:'doughnut',
            data:{labels:Object.keys(data.por_tipo||{}),
            datasets:[{data:Object.values(data.por_tipo||{}),backgroundColor:['#1976d2','#ec407a']}]},
            options:{devicePixelRatio:2,plugins:{title:{display:true,text:'Nominaciones por tipo'}}}
        });

        chartValor=new Chart(document.getElementById('chart_valor'),{
            type:'bar',
            data:{labels:data.por_valor.map(d=>d.valor),
            datasets:[{data:data.por_valor.map(d=>d.n),backgroundColor:'#42a5f5'}]},
            options:{devicePixelRatio:2,plugins:{title:{display:true,text:'Top valores nominados'}},scales:{y:{beginAtZero:true}}}
        });

        chartDia=new Chart(document.getElementById('chart_dia'),{
            type:'line',
            data:{labels:data.por_dia.map(d=>d.fecha),
            datasets:[{data:data.por_dia.map(d=>d.n),label:'Nominaciones',
            borderColor:'#7b0000',backgroundColor:'rgba(123,0,0,0.1)',tension:0.4,fill:true}]},
            options:{devicePixelRatio:2,plugins:{title:{display:true,text:'Nominaciones por día'}}}
        });
    }catch(e){console.error("Error:",e);}
}

// ===============================
// 🔹 Cargar maestros + buscador
// ===============================
async function cargarMaestros() {
    const r = await fetch('/admin/catalogo/maestros');
    const maestros = await r.json();
    const select = document.getElementById('maestro-select');
    const input = document.getElementById('maestro-search');

    // 🔹 Llenar inicialmente
    select.innerHTML = '';
    maestros.forEach(m => {
        const opt = document.createElement('option');
        opt.value = m.id;
        opt.textContent = m.nombre;
        select.appendChild(opt);
    });

    // 🔹 Filtro dinámico mientras se escribe
    input.addEventListener('input', () => {
        const term = input.value.toLowerCase().trim();
        const filtrados = maestros.filter(m => m.nombre.toLowerCase().includes(term));

        select.innerHTML = '';
        filtrados.forEach(m => {
            const opt = document.createElement('option');
            opt.value = m.id;
            opt.textContent = m.nombre;
            select.appendChild(opt);
        });

        // Si solo hay un maestro coincidente → selección automática
        if (filtrados.length === 1) {
            select.value = filtrados[0].id;
        }
    });
}

// ===============================
// 🔹 Buscar nominaciones
// ===============================
async function buscarNominaciones(){
    const maestro=document.getElementById('maestro-select').value;
    const mes=document.getElementById('mes-export').value;
    if(!maestro||!mes)return alert("Selecciona maestro y mes");
    const r=await fetch(`${URL_LISTAR}?maestro_id=${maestro}&mes=${mes}`);
    const data=await r.json();
    const tbody=document.querySelector('#tabla-nominaciones tbody');
    tbody.innerHTML="";
    data.forEach(n=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `
        <td><input type="checkbox" class="chk-nom" value="${n.id}" checked></td>
        <td>${n.fecha}</td>
        <td>${n.tipo}</td>
        <td>${n.nominado}</td>
        <td><span class="chip-bloque">${n.bloque || "—"}</span></td>
        <td>${n.valor}</td>
        <td>${n.comentario}</td>
        <td>${n.evento}</td>
        `;
        tbody.appendChild(tr);
    });
    document.getElementById('btn-generar-pdf').disabled=data.length===0;
}

document.getElementById('select-all').addEventListener('change',e=>{
    document.querySelectorAll('.chk-nom').forEach(chk=>chk.checked=e.target.checked);
});

// ===============================
// 🔹 Generar PDFs con progreso real
// ===============================
async function generarPDFsSeleccionados(){
    const seleccionados=[...document.querySelectorAll('.chk-nom:checked')].map(chk=>parseInt(chk.value));
    if(!seleccionados.length)return alert("Selecciona al menos una nominación");

    mostrarCargando(true,"Generando invitaciones...");
    const url=`${URL_GENERAR}?ids=${seleccionados.join(",")}`;
    const evtSource=new EventSource(url);

    evtSource.onmessage=(event)=>{
        const data=JSON.parse(event.data);
        if(data.progreso){
            const barra=document.getElementById("progress-fill");
            const texto=document.getElementById("progress-text");
            barra.style.width=`${data.progreso}%`;
            texto.textContent=`${data.procesados}/${data.total} (${data.progreso}%)`;
        }
        if(data.finalizado){
            evtSource.close();
            const barra=document.getElementById("progress-fill");
            const texto=document.getElementById("progress-text");
            barra.style.width="100%";
            texto.textContent="100% (completado)";
            texto.classList.add("completado");

            setTimeout(()=>{
                mostrarCargando(false);
                // ✅ Incluye subcarpeta en la URL
                fetch(`/invitaciones/${data.subcarpeta}/${data.nombre_zip}`)
                .then(r=>r.blob())
                .then(b=>{
                    const url=URL.createObjectURL(b);
                    const a=document.createElement('a');
                    a.href=url; a.download=data.nombre_zip;
                    a.click();
                    URL.revokeObjectURL(url);
                });
            },1000);
        }
    };

    evtSource.onerror=(e)=>{
        console.error("Error SSE:",e);
        evtSource.close();
        mostrarCargando(false);
        alert("Error generando las invitaciones.");
    };
}

// ===============================
// 🔹 Inicialización
// ===============================
document.addEventListener('DOMContentLoaded',()=>{
    const mesInicial=document.getElementById('mes-dashboard')?.value;
    cargarDashboard(mesInicial);
    document.getElementById('mes-dashboard').addEventListener('change',()=>cargarDashboard(document.getElementById('mes-dashboard').value));
    cargarMaestros();
    document.getElementById('btn-buscar-nominaciones').addEventListener('click',buscarNominaciones);
    document.getElementById('btn-generar-pdf').addEventListener('click',generarPDFsSeleccionados);
});
</script>

</body>
</html>
