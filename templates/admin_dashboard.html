<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Dashboard del Administrador</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin_dashboard.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/header.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<header class="admin-header">
    <div class="header-left">
        <h1>ðŸ“Š Dashboard del Administrador</h1>
    </div>
    <div class="header-right">
        <span>{{ current_user.nombre }}</span>
        <a href="{{ url_for('nom.panel_admin') }}" class="btn-volver">â†© Volver al panel</a>
    </div>
</header>

<main class="dashboard-container">
    <!-- KPIs principales -->
    <section class="kpis">
        <div class="card">
            <h3>Maestros</h3>
            <div id="k_maestros">â€“</div>
        </div>
        <div class="card">
            <h3>Alumnos</h3>
            <div id="k_alumnos">â€“</div>
        </div>
        <div class="card">
            <h3>Nominaciones</h3>
            <div id="k_nominaciones">â€“</div>
        </div>
    </section>

    <!-- GrÃ¡ficas -->
    <section class="charts">
        <div class="chart-box">
            <canvas id="chart_tipo"></canvas>
        </div>
        <div class="chart-box">
            <canvas id="chart_valor"></canvas>
        </div>
        <div class="chart-box full-width">
            <canvas id="chart_dia"></canvas>
        </div>
    </section>
</main>

<script>
async function cargarDashboard() {
    try {
        const res = await fetch("/admin/dashboard/data/resumen");
        const data = await res.json();

        if (data.error) {
            alert(data.error);
            return;
        }

        // KPIs
        document.getElementById('k_maestros').textContent = data.totales.maestros;
        document.getElementById('k_alumnos').textContent = data.totales.alumnos;
        document.getElementById('k_nominaciones').textContent = data.totales.nominaciones;

        // === GrÃ¡fica 1: Nominaciones por tipo ===
        const ctxTipo = document.getElementById('chart_tipo').getContext('2d');
        new Chart(ctxTipo, {
            type: 'doughnut',
            data: {
                labels: Object.keys(data.por_tipo || {}),
                datasets: [{
                    data: Object.values(data.por_tipo || {}),
                    backgroundColor: ['#1976d2', '#ec407a'],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                plugins: {
                    title: {
                        display: true,
                        text: 'Nominaciones por tipo',
                        font: { size: 16, weight: 'bold' }
                    },
                    legend: {
                        position: 'bottom'
                    }
                },
                responsive: true,
                maintainAspectRatio: false
            }
        });

        // === GrÃ¡fica 2: Top valores nominados ===
        const ctxValor = document.getElementById('chart_valor').getContext('2d');
        new Chart(ctxValor, {
            type: 'bar',
            data: {
                labels: data.por_valor.map(d => d.valor),
                datasets: [{
                    data: data.por_valor.map(d => d.n),
                    backgroundColor: '#42a5f5',
                    borderRadius: 6
                }]
            },
            options: {
                plugins: {
                    title: {
                        display: true,
                        text: 'Top valores nominados',
                        font: { size: 16, weight: 'bold' }
                    },
                    legend: { display: false }
                },
                scales: {
                    y: { beginAtZero: true, ticks: { stepSize: 1 } }
                },
                responsive: true,
                maintainAspectRatio: false
            }
        });

        // === GrÃ¡fica 3: Nominaciones por dÃ­a ===
        const ctxDia = document.getElementById('chart_dia').getContext('2d');
        new Chart(ctxDia, {
            type: 'line',
            data: {
                labels: data.por_dia.map(d => d.fecha),
                datasets: [{
                    data: data.por_dia.map(d => d.n),
                    label: 'Nominaciones',
                    borderColor: '#7b0000',
                    backgroundColor: 'rgba(123,0,0,0.1)',
                    tension: 0.4,
                    fill: true,
                    pointRadius: 4,
                    pointBackgroundColor: '#7b0000'
                }]
            },
            options: {
                plugins: {
                    title: {
                        display: true,
                        text: 'Nominaciones por dÃ­a',
                        font: { size: 16, weight: 'bold' }
                    },
                    legend: { display: false }
                },
                responsive: true,
                maintainAspectRatio: false
            }
        });

    } catch (err) {
        console.error("Error cargando dashboard:", err);
    }
}

document.addEventListener('DOMContentLoaded', cargarDashboard);
</script>
</body>
</html>
