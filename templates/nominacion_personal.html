<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Nominaciones de Personal</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/nominacion_personal.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>

<!-- üîπ Encabezado institucional -->
<header class="admin-header">
    <div class="header-left">
        <h1>üçé Nominaciones de personal del ciclo {{ ciclo.nombre }}</h1>
    </div>
    <div class="header-right">
        
        <span>{{ current_user.nombre }}</span>

        <a href="{{ url_for('nom.panel_profesor') }}" class="btn-volver">‚Üê Volver al panel del maestro</a>
    </div>
</header>

<!-- üîπ Mensajes flash -->
<div id="flash-container">
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="flash flash-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}
</div>

<main class="contenedor-principal">
<!-- üîπ Estado del evento vigente -->
    {% if evento and evento.activo %}
        {% set cierre = evento.fecha_cierre_nominaciones
            .replace(tzinfo=zoneinfo.ZoneInfo('UTC'))
            .astimezone(zoneinfo.ZoneInfo('America/Merida')) %}

        <div class="alerta-evento activo">
            <p>
                üóìÔ∏è <strong>Evento vigente:</strong> {{ evento.nombre_mes }}
                (Cierra el <strong>{{ cierre.strftime('%d/%m/%Y %H:%M') }}</strong>)
            </p>
        </div>
    {% else %}
        <div class="alerta-evento inactivo">
            <p>‚ö†Ô∏è No hay ning√∫n evento de asamblea activo actualmente.</p>
        </div>
    {% endif %}

    <!-- üîπ Formulario principal -->
    <section class="formulario-nominacion">
        <h2>Registrar nueva nominaci√≥n</h2>

        {% if evento and evento.activo %}
        <!-- Buscador -->
        <label for="buscador">Buscar maestro:</label>
        <input type="text" id="buscador" placeholder="Escribe un nombre para filtrar...">

        <form method="POST" class="form-nominacion">
            <label for="maestros">Selecciona maestro(s):</label>
            <select name="maestros" id="maestros" multiple required>
                {% for m in maestros %}
                    <option value="{{ m.id }}">{{ m.nombre }}</option>
                {% endfor %}
            </select>

            <label for="valor_id">Selecciona el valor:</label>
            <select name="valor_id" id="valor_id" required>
                <option value="">Selecciona un valor</option>
                {% for valor in valores %}
                    <option value="{{ valor.id }}">{{ valor.nombre }}</option>
                {% endfor %}
            </select>

            <label for="comentario">Comentario (opcional):</label>
            <textarea id="comentario"
                    name="comentario"
                    placeholder="Escribe un comentario..."
                    spellcheck="true"
                    lang="es"
                    class="textarea-comentario"></textarea>

                    <p class="nota-ortografia">
                        üîç Este campo admite correcci√≥n ortogr√°fica autom√°tica si est√° activada en su navegador.

                        En Windows, para Chrome, debes ACTIVAR la funci√≥n:

                        üîπ Chrome ‚Üí Configuraci√≥n ‚Üí Idiomas
                    </p>

            <button type="submit" class="btn-registrar">Registrar nominaci√≥n</button>
        </form>
        {% else %}
        <div class="bloqueo-form">
            <p>üö´ No hay eventos vigentes para registrar nominaciones.</p>
        </div>
        {% endif %}
    </section>

    <!-- üîπ Tabla de nominaciones registradas -->
    <section class="tabla-nominaciones">
        <h2>üßæ Tus nominaciones registradas</h2>

        {% if nominaciones %}
        <div class="tabla-scroll">
            <table>
                <thead>
                    <tr>
                        <th>Nominas a</th>
                        <th>Valor</th>
                        <th>Comentario</th>
                        <th>Fecha</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for n in nominaciones %}
                    {% if n.maestro_nominado %}
                    <tr>
                        <td>{{ n.maestro_nominado.nombre }}</td>
                        <td>{{ n.valor.nombre }}</td>
                        <td>{{ n.comentario or '-' }}</td>
                        <td>{{ n.fecha.strftime('%d/%m/%Y') }}</td>
                        <td class="acciones">
                            <button class="btn-editar" 
                                    data-id="{{ n.id }}" 
                                    data-valor="{{ n.valor.id }}" 
                                    data-comentario="{{ n.comentario or '' }}">‚úèÔ∏è</button>
                            <button class="btn-eliminar" data-id="{{ n.id }}">üóëÔ∏è</button>
                        </td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="sin-datos">No tienes nominaciones registradas a√∫n.</p>
        {% endif %}
    </section>
</main>

<script>
document.addEventListener("DOMContentLoaded", () => {

    // üîç Filtro de b√∫squeda de maestros
    const buscador = document.getElementById("buscador");
    const selectMaestros = document.getElementById("maestros");

    if (buscador && selectMaestros) {
        buscador.addEventListener("input", () => {
            const filtro = buscador.value.toLowerCase();
            for (let option of selectMaestros.options) {
                const texto = option.text.toLowerCase();
                option.style.display = texto.includes(filtro) ? "" : "none";
            }
        });
    }

    // üóëÔ∏è Eliminar nominaci√≥n
    document.querySelectorAll(".btn-eliminar").forEach(btn => {
        btn.addEventListener("click", e => {
            e.preventDefault();
            const id = btn.dataset.id;
            Swal.fire({
                title: "¬øEliminar nominaci√≥n?",
                text: "Esta acci√≥n no se puede deshacer.",
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#800000",
                cancelButtonColor: "#888",
                confirmButtonText: "S√≠, eliminar",
                cancelButtonText: "Cancelar"
            }).then(result => {
                if (result.isConfirmed) {
                    window.location.href = `/nominaciones/personal/eliminar/${id}`;
                }
            });
        });
    });

    // ‚úèÔ∏è Editar nominaci√≥n
    document.querySelectorAll(".btn-editar").forEach(btn => {
        btn.addEventListener("click", e => {
            e.preventDefault();
            const id = btn.dataset.id;
            const valorActual = btn.dataset.valor;
            const comentarioActual = btn.dataset.comentario;

            const valores = {{ valores_json | tojson }};
            const opciones = valores.map(v => 
                `<option value="${v.id}" ${v.id == valorActual ? 'selected' : ''}>${v.nombre}</option>`
            ).join('');

            Swal.fire({
                title: "Editar nominaci√≥n",
                html: `
                    <label style='font-weight:600;'>Selecciona nuevo valor:</label>
                    <select id='nuevo_valor' class='swal2-input'>${opciones}</select>
                    <label style='font-weight:600;'>Comentario:</label>
                    <textarea id='nuevo_comentario' 
                    class='swal2-textarea' 
                    placeholder='Comentario opcional...'
                    spellcheck="true"
                    lang="es"
                    style="height: 90px;">${comentarioActual || ''}</textarea>
                `,
                confirmButtonText: "Guardar cambios",
                confirmButtonColor: "#800000",
                showCancelButton: true,
                cancelButtonText: "Cancelar",
                preConfirm: () => {
                    const valor_id = document.getElementById("nuevo_valor").value;
                    const comentario = document.getElementById("nuevo_comentario").value;
                    fetch(`/nominaciones/personal/editar/${id}`, {
                        method: "POST",
                        headers: { "Content-Type": "application/x-www-form-urlencoded" },
                        body: `valor_id=${valor_id}&comentario=${encodeURIComponent(comentario)}`
                    }).then(() => {
                        Swal.fire("‚úÖ Guardado", "Nominaci√≥n actualizada correctamente.", "success")
                            .then(() => location.reload());
                    });
                }
            });
        });
    });
});
</script>

</body>
</html>
