<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Matriz del grupo {{ grado }}Â°{{ grupo }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/matriz_grupo_maestro.css') }}">
</head>
<body>

    <!-- ğŸ”¹ Header institucional -->
    <header class="admin-header">
        <div class="header-left">
            <h1>ğŸ‘©â€ğŸ« Nominaciones de {{ grado }}Â°{{ grupo }} - {{ bloque.nombre }}</h1>
        </div>
        <div class="header-right">
            
            <span>{{ current_user.nombre }}</span>

            <a href="{{ url_for('nom.grupos_por_grado', bloque_id=bloque.id, grado=grado) }}" class="btn-volver-top">
                â† Volver a la selecciÃ³n de grupo
            </a>
        </div>
    </header>

    <!-- ğŸ”¸ Mensajes flash -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div id="flash-container">
            {% for category, message in messages %}
                <div class="flash flash-{{ category }}">{{ message }}</div>
            {% endfor %}
        </div>
        {% endif %}
    {% endwith %}

    <!-- ğŸ”¹ Panel informativo superior -->
    <section class="info-panel">
        <p>
            ğŸ« <strong>Ciclo:</strong> {{ ciclo.nombre if ciclo else 'â€”' }} |
            ğŸ“š <strong>Bloque:</strong> {{ bloque.nombre }} |
            ğŸ“ <strong>Grado:</strong> {{ grado }}Â°{{ grupo }}
        </p>
        {% if evento_abierto %}
        <p>
            ğŸ“… <strong>Evento activo:</strong> {{ evento_abierto.nombre_mes }}
            (Cierra: {{ evento_abierto.fecha_cierre_nominaciones.strftime('%d/%m/%Y %H:%M') }})
        </p>
        {% else %}
        <p class="sin-evento">âš ï¸ No hay evento activo para este bloque.</p>
        {% endif %}
    </section>

    <!-- ğŸ”¹ Contenido principal -->
    <main class="contenedor-matriz">
        <h3 class="subtitulo">Selecciona un alumno para registrar su nominaciÃ³n</h3>

        <table class="tabla-matriz">
            <thead>
                <tr>
                    <th>Alumno</th>
                    {% for evento in eventos %}
                        <th>{{ evento.nombre_mes }}<br><small>{{ evento.fecha_evento.strftime('%Y-%m-%d') }}</small></th>
                    {% endfor %}
                    <th>Aviso</th>
                    <th>AcciÃ³n</th>
                </tr>
            </thead>
            <tbody>
                {% for item in alumnos %}
                <tr>
                    <td>
                        <a class="nombre-alumno">
                            {{ item.alumno.nombre }} ({{ item.alumno.grado }}{{ item.alumno.grupo }})
                        </a>
                    </td>

                    {% for evento in eventos %}
                    <td>
                        {% if item.valores[evento.mes_ordinal|string] %}
                            {% set valores_mes = item.valores[evento.mes_ordinal|string] %}

                            {# ğŸŸ¡ Caso 1: si ya tiene EXCELENCIA asignada directamente #}
                            {% if valores_mes|length == 1 and valores_mes[0].valor == "EXCELENCIA" %}
                                <span class="punto dorado" 
                                    title="EXCELENCIA ğŸ… â€” {{ valores_mes[0].comentario }}">
                                </span>

                            {# ğŸŸ¡ Caso 2: si tiene 3 o mÃ¡s valores normales, mostrar punto dorado tipo EXCELENCIA #}
                            {% elif valores_mes|length >= 3 %}
                                <span class="punto dorado" 
                                    title="EXCELENCIA ğŸ… â€” AlcanzÃ³ este reconocimiento por tres nominaciones previas.">
                                </span>

                            {# ğŸŸ¢ Caso 3: puntos normales #}
                            {% else %}
                                {% for v in valores_mes %}
                                    <span class="punto verde" 
                                        title="{{ v.valor }}{% if v.maestro %} â€” {{ v.maestro }}{% endif %}{% if v.fecha %} ({{ v.fecha }}){% endif %}">
                                    </span>
                                {% endfor %}
                            {% endif %}
                        {% else %}
                            <span class="punto gris"></span>
                        {% endif %}
                    </td>
                    {% endfor %}

                    <td class="aviso">
                        {% if item.sin_nominacion_total %}
                            âš ï¸ Sin nominaciÃ³n previa
                        {% endif %}
                    </td>
                    <td>
                        {% if mes_actual %}
                            {% if evento_abierto and evento_abierto.mes_ordinal == mes_actual %}
                                <a href="{{ url_for('nom.nominar_alumno_individual', alumno_id=item.alumno.id) }}" class="btn-nominar">
                                    Nominar
                                </a>
                            {% else %}
                                <button class="btn-nominar" disabled style="opacity:0.6;">Bloqueado</button>
                            {% endif %}
                        {% else %}
                            <button class="btn-nominar" disabled style="opacity:0.6;">Bloqueado</button>
                        {% endif %}
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="{{ eventos|length + 3 }}" class="sin-datos">No hay alumnos en este grupo.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </main>

    <script>
    // Hace que los mensajes desaparezcan automÃ¡ticamente
    setTimeout(() => {
        document.querySelectorAll('.flash').forEach(el => {
            el.classList.add('hide');
            setTimeout(() => el.remove(), 600); // Se elimina despuÃ©s de desvanecerse
        });
    }, 3000);
    </script>
</body>
</html>
