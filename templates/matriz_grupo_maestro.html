<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Matriz del grupo {{ grado }}¬∞{{ grupo }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/matriz_grupo_maestro.css') }}">
</head>
<body>

    <!-- üîπ Header institucional -->
    <header class="admin-header">
        <div class="header-left">
            <h1>üë©‚Äçüè´ Nominaciones de {{ grado }}¬∞{{ grupo }} - {{ bloque.nombre }}</h1>
        </div>

        <a href="{{ url_for('nom.inicio_rapido') }}" class="btn-inicio-rapido">üè´ Inicio</a>
        <div class="header-right">
            <span>{{ current_user.nombre }}</span>
            <a href="{{ url_for('nom.grupos_por_grado', bloque_id=bloque.id, grado=grado) }}" class="btn-volver-top">
                ‚Üê Volver a la selecci√≥n de grupo
            </a>
        </div>
    </header>

    <!-- üî∏ Mensajes flash -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div id="flash-container">
            {% for category, message in messages %}
                <div class="flash flash-{{ category }}">{{ message }}</div>
            {% endfor %}
        </div>
        {% endif %}
    {% endwith %}

    <!-- üîπ Panel informativo superior -->
    {% set ns_global = namespace(total_alumnos_nominados_mes=0) %}

    {# üîπ Contamos cu√°ntos alumnos ya tienen nominaciones en el evento/mes actual #}
    {% if evento_abierto %}
        {% set mes_actual_ordinal = evento_abierto.mes_ordinal|string %}
        {% for item in alumnos %}
            {% if item.valores.get(mes_actual_ordinal) %}
                {% set lista_actual = item.valores.get(mes_actual_ordinal) %}
                {% if lista_actual|length > 0 %}
                    {% set ns_global.total_alumnos_nominados_mes = ns_global.total_alumnos_nominados_mes + 1 %}
                {% endif %}
            {% endif %}
        {% endfor %}
    {% endif %}

    {# üîπ Ajuste autom√°tico seg√∫n nivel educativo #}

    {# Kinder = 8 #}
    {% if 'K' in grupo or 'K' in grado %}
        {% set max_permitido = 8 %}

    {# Secundaria = 11 #}
    {% elif 'SEC' in grado or 'SEC' in grupo or 'Sec' in grado or 'Secundaria' in grado %}
        {% set max_permitido = 11 %}

    {% else %}
        {# ---- PRIMARIA ---- #}

        {# Extraemos solo el n√∫mero del grado de forma segura #}
        {% set grado_str = grado.split('-')[0].strip() %}
        {% set grado_num = 0 %}
        {% if grado_str.isdigit() %}
            {% set grado_num = grado_str | int %}
        {% endif %}

        {# Primaria alta 4¬∞, 5¬∞, 6¬∞ = 11 #}
        {% if grado_num >= 4 and grado_num <= 6 %}
            {% set max_permitido = 11 %}

        {# Primaria baja 1¬∞, 2¬∞, 3¬∞ = 8 #}
        {% elif grado_num >= 1 and grado_num <= 3 %}
            {% set max_permitido = 8 %}

        {% else %}
            {# Default seguro #}
            {% set max_permitido = 8 %}
        {% endif %}
    {% endif %}

    <section class="info-panel">
        <p>
            üè´ <strong>Ciclo:</strong> {{ ciclo.nombre if ciclo else '‚Äî' }} |
            üìö <strong>Bloque:</strong> {{ bloque.nombre }} |
            üéì <strong>Grado:</strong> {{ grado }}¬∞{{ grupo }}
        </p>
        {% if evento_abierto %}
        {% set cierre = evento_abierto.fecha_cierre_nominaciones
            .replace(tzinfo=zoneinfo.ZoneInfo('UTC'))
            .astimezone(zoneinfo.ZoneInfo('America/Merida')) %}

        <p>
            üìÖ <strong>Evento activo:</strong> {{ evento_abierto.nombre_mes }}
            (Cierra: {{ cierre.strftime('%d/%m/%Y %H:%M') }})
        </p>
        <p style="font-weight:600; color:#7b0000;">
            üë• Alumnos nominados en {{ grupo }} ({{ evento_abierto.nombre_mes }}): 
            {{ ns_global.total_alumnos_nominados_mes }} / {{ max_permitido }}
            {% if ns_global.total_alumnos_nominados_mes >= max_permitido %}
                <span style="color:#b30000;">‚Äî L√≠mite alcanzado</span>
            {% endif %}
        </p>
        {% else %}
        <p class="sin-evento">‚ö†Ô∏è No hay evento activo para este bloque.</p>
        {% endif %}
    </section>

    <!-- üîπ Contenido principal -->
    <main class="contenedor-matriz">
        <h3 class="subtitulo">Selecciona un alumno para registrar su nominaci√≥n</h3>
        <div class="orden-container">
            <button id="btn-ordenar" class="btn-ordenar">
                üî§ Ordenar por apellido
            </button>
        </div>

        <table class="tabla-matriz">
            <thead>
                <tr>
                    <th>Alumno</th>
                    {% for evento in eventos %}
                        <th>{{ evento.nombre_mes }}<br><small>{{ evento.fecha_evento.strftime('%Y-%m-%d') }}</small></th>
                    {% endfor %}
                    <th>Aviso</th>
                    <th>Acci√≥n</th>
                </tr>
            </thead>
            <tbody>
                {% for item in alumnos %}
                {% set ns = namespace(tiene_excelencia_mes=false, total_nominaciones=0) %}

                {# üîπ Contar nominaciones del ciclo (para avisos) #}
                {% for lista_valores in item.valores.values() %}
                    {% set ns.total_nominaciones = ns.total_nominaciones + lista_valores|length %}
                {% endfor %}

                {# üîπ Revisar excelencia SOLO en el mes actual #}
                {% set valores_mes_actual = item.valores.get(evento_abierto.mes_ordinal|string, []) %}

                {% for v in valores_mes_actual %}
                    {% if v.valor == "EXCELENCIA" %}
                        {% set ns.tiene_excelencia_mes = true %}
                    {% endif %}
                {% endfor %}

                <tr>
                    <td>
                        <a class="nombre-alumno">
                            {{ loop.index }}.&nbsp; {{ item.alumno.nombre }}
                        </a>
                    </td>

                    {% for evento in eventos %}
            <td>
                {% if item.valores[evento.mes_ordinal|string] %}
                    {% set valores_mes = item.valores[evento.mes_ordinal|string] %}

                    {# extraer solo los nombres de los valores #}
                    {% set nombres_valores = valores_mes | map(attribute='valor') | list %}
                    {% set valores_unicos = nombres_valores | unique | list %}

                    {# CASO 1: Si hay EXCELENCIA ‚Üí punto dorado, mostrando historial completo #}
                    {% if 'EXCELENCIA' in valores_unicos %}
                        {% set excelencia = valores_mes | selectattr('valor', 'equalto', 'EXCELENCIA') | list | first %}
                        
                        {% set otros = valores_mes | rejectattr('valor', 'equalto', 'EXCELENCIA') | list %}

                        <span class="punto dorado"
                            title="
                    EXCELENCIA üèÖ ‚Äî {{ excelencia.maestro }} ({{ excelencia.fecha }})

                    {% if otros|length > 0 %}
                    Nominaciones previas:
                    {% for n in otros %}
                    ‚Ä¢ {{ n.valor }} ‚Äî {{ n.maestro }} ({{ n.fecha }})
                    {% endfor %}
                    {% endif %}
                            ">
                        </span>

                    {# CASO 2: Si hay 3 valores distintos ‚Üí excelencia autom√°tica #}
                    {% elif valores_unicos|length >= 3 %}
                        <span class="punto dorado"
                            title="EXCELENCIA üèÖ ‚Äî Obtenida por tres nominaciones previas: {{ valores_unicos | join(', ') }}">
                        </span>

                    {# CASO 3: valores normales ‚Üí verdes #}
                    {% else %}
                        {% for nombre in valores_unicos %}
                        {% set v = valores_mes | selectattr('valor', 'equalto', nombre) | list | first %}
                        <span class="punto verde"
                            title="{{ nombre }}{% if v.maestro %} ‚Äî {{ v.maestro }}{% endif %}{% if v.fecha %} ({{ v.fecha }}){% endif %}">
                        </span>
                        {% endfor %}
                    {% endif %}

                {% else %}
                    <span class="punto gris"></span>
                {% endif %}
            </td>


                    {% endfor %}

                    <!-- üî∏ Avisos -->
                    <td class="aviso">
                        {% if ns.total_nominaciones == 0 %}
                            ‚ö†Ô∏è Sin nominaci√≥n previa<br>üü° Nominaciones del ciclo faltantes: <strong>2</strong>
                        {% elif ns.total_nominaciones == 1 %}
                            üü° Nominaciones del ciclo faltantes: <strong>1</strong>
                        {% endif %}
                    </td>

                    <!-- üî∏ Bot√≥n acci√≥n -->
                    <td>
                        {% if mes_actual %}
                            {% if evento_abierto and evento_abierto.mes_ordinal == mes_actual %}
                                {% if ns.tiene_excelencia_mes %}
                                    <button class="btn-nominar" disabled title="No se puede nominar a un alumno con grado EXCELENCIA.">Nominar</button>
                                {% elif ns_global.total_alumnos_nominados_mes >= max_permitido %}
                                    <button class="btn-nominar" disabled title="Se alcanz√≥ el l√≠mite de nominaciones para este mes.">Nominar</button>
                                {% else %}
                                    <a href="{{ url_for('nom.nominar_alumno_individual', alumno_id=item.alumno.id) }}" class="btn-nominar">Nominar</a>
                                {% endif %}
                            {% else %}
                                <button class="btn-nominar" disabled style="opacity:0.6;">Bloqueado</button>
                            {% endif %}
                        {% else %}
                            <button class="btn-nominar" disabled style="opacity:0.6;">Bloqueado</button>
                        {% endif %}
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="{{ eventos|length + 3 }}" class="sin-datos">No hay alumnos en este grupo.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </main>

    <script>
        // üí¨ Hace que los mensajes desaparezcan autom√°ticamente
        setTimeout(() => {
            document.querySelectorAll('.flash').forEach(el => {
                el.classList.add('hide');
                setTimeout(() => el.remove(), 600);
            });
        }, 3000);

        // üß† Funci√≥n para sacar apellidos (√∫ltimas dos palabras) ignorando el n√∫mero inicial "1. "
        function extraerApellido(texto) {
            // Quita "12. " del inicio si existe
            texto = texto.replace(/^\d+\.\s*/, "").trim();

            const partes = texto.split(/\s+/);
            if (partes.length === 1) {
                return partes[0].toLowerCase();
            }
            return partes.slice(-2).join(" ").toLowerCase();
        }

        // üîÅ Renumerar las filas visualmente (1., 2., 3., ...)
        function renumerarFilas(tabla, selectorNombre) {
            const filas = tabla.querySelectorAll("tr");
            let contador = 1;

            filas.forEach(fila => {
                const celda = fila.querySelector(selectorNombre);
                if (celda) {
                    let nombreActual = celda.innerText.trim();
                    // quita numeraci√≥n previa "x. "
                    nombreActual = nombreActual.replace(/^\d+\.\s*/, "");
                    celda.innerText = `${contador}. ${nombreActual}`;
                    contador++;
                }
            });
        }

        // üß∑ Configuraci√≥n cuando cargue la p√°gina
        document.addEventListener("DOMContentLoaded", () => {
            const tabla = document.querySelector(".tabla-matriz tbody");
            const boton = document.getElementById("btn-ordenar");

            if (!tabla || !boton) return;

            // Guardamos el orden ORIGINAL de las filas
            const filasIniciales = tabla.querySelectorAll("tr");
            let i = 1;
            filasIniciales.forEach(fila => {
                fila.dataset.ordenOriginal = i;  // 1, 2, 3, ...
                i++;
            });

            // Estado inicial: orden por n√∫mero (nombre)
            boton.dataset.apellido = "false";

            boton.addEventListener("click", function () {
                const filas = Array.from(tabla.querySelectorAll("tr"));
                const usandoApellido = this.dataset.apellido === "true";

                if (!usandoApellido) {
                    // üëâ Ordenar por apellido (ascendente)
                    filas.sort((a, b) => {
                        const nomA = a.querySelector(".nombre-alumno").innerText;
                        const nomB = b.querySelector(".nombre-alumno").innerText;
                        return extraerApellido(nomA).localeCompare(extraerApellido(nomB));
                    });
                    this.textContent = "‚Ü© Ordenar por nombre";
                    this.dataset.apellido = "true";
                } else {
                    // üëâ Restaurar al orden ORIGINAL (por data-orden-original)
                    filas.sort((a, b) => {
                        const ordA = parseInt(a.dataset.ordenOriginal || "0", 10);
                        const ordB = parseInt(b.dataset.ordenOriginal || "0", 10);
                        return ordA - ordB;
                    });
                    this.textContent = "üî§ Ordenar por apellido";
                    this.dataset.apellido = "false";
                }

                // Reinsertar filas en el nuevo orden
                filas.forEach(f => tabla.appendChild(f));

                // Renumerar 1., 2., 3., ... siempre sobre el orden actual
                renumerarFilas(tabla, ".nombre-alumno");
            });
        });
    </script>

</body>
</html>