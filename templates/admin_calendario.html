<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Calendario de Asambleas</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/panel_admin.css') }}">
    <style>
        .calendar-container { max-width: 1200px; margin: 40px auto; background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 3px 10px rgba(0,0,0,0.1);}
        h1 { color: #7b0000; margin-bottom: 10px; }
        form { display: grid; grid-template-columns: repeat(auto-fit,minmax(180px,1fr)); gap: 15px; margin-bottom: 25px; }
        input, select { padding: 8px; border-radius: 8px; border: 1px solid #ccc; width: 100%; }
        button { background: #7b0000; color: white; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; grid-column: span 2; }
        button:hover { background: #a00000; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.95em; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
        th { background: #f0f0f0; color: #7b0000; }
        .btn-eliminar { color: #a00; cursor: pointer; }
        .btn-eliminar:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div class="calendar-container">
        <h1>ðŸ“… Calendario de Asambleas â€“ {{ ciclo.nombre }}</h1>

        <form method="POST">
            <select name="bloque_id" required>
                <option value="">Seleccione bloque</option>
                {% for b in bloques %}
                <option value="{{ b.id }}">{{ b.nombre }}</option>
                {% endfor %}
            </select>

            <input type="number" name="mes_ordinal" placeholder="NÃºmero de mes (1..N)" required>
            <input type="text" name="nombre_mes" placeholder="Nombre del mes" required>
            <input type="date" name="fecha_evento" required>
            <input type="datetime-local" name="fecha_cierre_nominaciones" required>

            <select name="plantilla_id">
                <option value="">Plantilla predeterminada</option>
                {% for p in plantillas %}
                <option value="{{ p.id }}">{{ p.nombre }}</option>
                {% endfor %}
            </select>

            <button type="submit">Agregar evento</button>
        </form>

        {% if eventos %}
        <table>
            <tr>
                <th>Mes</th>
                <th>Bloque</th>
                <th>Fecha del evento</th>
                <th>Cierre de nominaciones</th>
                <th>Plantilla</th>
                <th>Estado</th>
                <th>Acciones</th>
            </tr>
            {% for e in eventos %}
            {% set hoy = datetime.utcnow() %}
            {% if e.fecha_cierre_nominaciones > hoy %}
                {% set estado = "ðŸŸ¢ Abierto" %}
            {% else %}
                {% set estado = "ðŸ”´ Cerrado" %}
            {% endif %}
            <tr id="fila-{{ e.id }}">
                <td>{{ e.mes_ordinal }} â€“ {{ e.nombre_mes }}</td>
                <td>{{ e.bloque.nombre }}</td>
                <td>{{ e.fecha_evento.strftime('%d/%m/%Y') }}</td>
                <td>{{ e.fecha_cierre_nominaciones.strftime('%d/%m/%Y %H:%M') }}</td>
                <td>{{ e.plantilla.nombre if e.plantilla else 'Predeterminada' }}</td>
                <td>{{ estado }}</td>
                <td>
                    <a href="#" class="btn-toggle" data-id="{{ e.id }}">
                        {{ "Desactivar" if e.activo else "Activar" }}
                    </a>
                    &nbsp;|&nbsp;
                    <a href="#" class="btn-eliminar" data-id="{{ e.id }}">Eliminar</a>
                </td>
            </tr>
            {% endfor %}
        </table>
        {% else %}
        <p>No hay eventos registrados para este ciclo.</p>
        {% endif %}
    </div>

    
    <script>
document.querySelectorAll('.btn-eliminar').forEach(btn => {
    btn.addEventListener('click', async e => {
        e.preventDefault();
        const id = btn.dataset.id;
        if (!confirm('Â¿Seguro que deseas eliminar este evento?')) return;

        const res = await fetch(`/admin/calendario/eliminar/${id}`, { method: 'DELETE' });
        const data = await res.json();
        if (data.success) {
            document.getElementById(`fila-${id}`).remove();
            alert('Evento eliminado correctamente.');
        } else {
            alert('Error: ' + (data.error || 'No se pudo eliminar'));
        }
    });
});

document.querySelectorAll('.btn-toggle').forEach(btn => {
    btn.addEventListener('click', async e => {
        e.preventDefault();
        const id = btn.dataset.id;

        const res = await fetch(`/admin/calendario/toggle/${id}`, { method: 'POST' });
        const data = await res.json();

        if (data.success) {
            btn.textContent = data.activo ? 'Desactivar' : 'Activar';
            alert(`Evento ${data.activo ? 'activado' : 'desactivado'} correctamente.`);
        } else {
            alert('Error: ' + (data.error || 'No se pudo actualizar el estado.'));
        }
    });
});
    </script>
</body>
</html>
