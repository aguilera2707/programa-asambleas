<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Calendario de Asambleas</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin_calendario.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/header.css') }}">
</head>

<body>

<header class="admin-header">
    <div class="header-left">
        <h1>📅 Calendario de Asambleas – {{ ciclo.nombre }}</h1>
    </div>
    <div class="header-right">
        <span>{{ current_user.nombre }}</span>
        <a href="{{ url_for('nom.panel_admin') }}" class="btn-volver">↩ Volver al panel</a>
    </div>
</header>

<main class="admin-main">
    <!-- 🔔 Mensajes flash -->
    <div id="flash-container">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="flash flash-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>

    <!-- 📋 Formulario de creación de eventos -->
    <section class="formulario-calendario">
        <form method="POST">
            <select name="bloque_id" required>
                <option value="">Seleccione bloque</option>
                {% for b in bloques %}
                    <option value="{{ b.id }}">{{ b.nombre }}</option>
                {% endfor %}
            </select>

            <input type="number" name="mes_ordinal" placeholder="Número de mes (1..N)" required>
            <input type="text" name="nombre_mes" placeholder="Nombre del mes" required>
            <input type="date" name="fecha_evento" required>
            <input type="datetime-local" name="fecha_cierre_nominaciones" required>

            <select name="plantilla_id">
                <option value="">Plantilla predeterminada</option>
                {% for p in plantillas %}
                    <option value="{{ p.id }}">{{ p.nombre }}</option>
                {% endfor %}
            </select>

            <button type="submit" class="btn btn-primary">➕ Agregar evento</button>
        </form>
    </section>

    <!-- 🗓️ Tabla de eventos -->
    <section class="tabla-calendario">
        {% if eventos %}
        <table>
            <thead>
                <tr>
                    <th>Mes</th>
                    <th>Bloque</th>
                    <th>Fecha del evento</th>
                    <th>Cierre de nominaciones</th>
                    <th>Plantilla</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for e in eventos %}
                {% set hoy = datetime.utcnow() %}
                {% if e.fecha_cierre_nominaciones > hoy %}
                    {% set estado = "Abierto" %}
                    {% set color = "abierto" %}
                {% else %}
                    {% set estado = "Cerrado" %}
                    {% set color = "cerrado" %}
                {% endif %}
                <tr id="fila-{{ e.id }}">
                    <td>{{ e.mes_ordinal }} – {{ e.nombre_mes }}</td>
                    <td>{{ e.bloque.nombre }}</td>
                    <td>{{ e.fecha_evento.strftime('%d/%m/%Y') }}</td>
                    <td>{{ e.fecha_cierre_nominaciones.strftime('%d/%m/%Y %H:%M') }}</td>
                    <td>{{ e.plantilla.nombre if e.plantilla else 'Predeterminada' }}</td>
                    <td><span class="estado {{ color }}">{{ estado }}</span></td>
                    <td>
                        <a href="#" class="btn-toggle" data-id="{{ e.id }}">
                            {{ "Desactivar" if e.activo else "Activar" }}
                        </a>
                        <span class="separador">|</span>
                        <a href="#" class="btn-eliminar" data-id="{{ e.id }}">Eliminar</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="sin-datos">No hay eventos registrados para este ciclo.</p>
        {% endif %}
    </section>
</main>

<script>
// 💨 Ocultar mensajes flash automáticamente
setTimeout(() => {
    document.querySelectorAll('.flash').forEach(el => {
        el.style.opacity = '0';
        el.style.transform = 'translateY(-10px)';
        setTimeout(() => el.remove(), 600);
    });
}, 3000);

// 🗑️ Eliminar evento
document.querySelectorAll('.btn-eliminar').forEach(btn => {
    btn.addEventListener('click', async e => {
        e.preventDefault();
        const id = btn.dataset.id;
        if (!confirm('¿Seguro que deseas eliminar este evento?')) return;

        const res = await fetch(`/admin/calendario/eliminar/${id}`, { method: 'DELETE' });
        const data = await res.json();
        if (data.success) {
            document.getElementById(`fila-${id}`).remove();
        } else {
            alert('Error: ' + (data.error || 'No se pudo eliminar'));
        }
    });
});

// 🔁 Activar/desactivar evento
document.querySelectorAll('.btn-toggle').forEach(btn => {
    btn.addEventListener('click', async e => {
        e.preventDefault();
        const id = btn.dataset.id;

        const res = await fetch(`/admin/calendario/toggle/${id}`, { method: 'POST' });
        const data = await res.json();

        if (data.success) {
            btn.textContent = data.activo ? 'Desactivar' : 'Activar';
            alert(`Evento ${data.activo ? 'activado' : 'desactivado'} correctamente.`);
        } else {
            alert('Error: ' + (data.error || 'No se pudo actualizar el estado.'));
        }
    });
});
</script>

</body>
</html>
