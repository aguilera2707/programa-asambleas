<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Alumnos del ciclo</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin_alumnos.css') }}">
</head>
<body>

<!-- üîπ Header institucional -->
<header class="admin-header">
    <div class="header-left">
        <h1>üéì Alumnos del ciclo {{ ciclo.nombre if ciclo else '‚Äî' }}</h1>
    </div>

    <div class="header-right">
        <span>{{ current_user.nombre }}</span>
        <a href="{{ url_for('nom.panel_admin') }}" class="btn-volver">‚Ü© Volver al panel</a>
    </div>
</header>

<main class="contenedor-principal">
    <section class="panel-alumnos">

        <!-- üßæ Mensajes flash -->
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flash-container">
                {% for category, message in messages %}
                    <div class="flash flash-{{ category }}">{{ message }}</div>
                {% endfor %}
            </div>
        {% endif %}
        {% endwith %}

        {% if ciclo %}
        <!-- üîπ Barra de acciones mejorada -->
        <div class="acciones-bar">
            <form action="{{ url_for('admin_bp.importar_alumnos_por_bloque') }}" method="POST" enctype="multipart/form-data" class="form-import">

                <div class="input-group">
                    <label for="bloque_id">Bloque:</label>
                    <select name="bloque_id" id="bloque_id" required>
                        <option value="">Selecciona bloque</option>
                        {% for b in bloques %}
                            <option value="{{ b.id }}">{{ b.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="input-group">
                    <label for="file">Archivo:</label>
                    <input type="file" id="file" name="file" accept=".xlsx,.csv" required>
                </div>

                <button type="submit" class="btn btn-primary">üì• Importar alumnos</button>
                <a href="{{ url_for('admin_bp.plantilla_alumnos_bloque') }}" class="btn btn-excel">üìó Descargar plantilla</a>
                <a href="{{ url_for('admin_bp.crear_alumno_manual') }}" class="btn btn-danger">‚ûï Crear manualmente</a>
            </form>
        </div>


        <!-- üîπ Tabla -->
        <h2 class="subtitulo">Listado de alumnos</h2>

        <table class="tabla">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Grado</th>
                    <th>Grupo</th>
                    <th>Nivel</th>
                    <th>Bloque</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for a in alumnos %}
                <tr data-id="{{ a.id }}">
                    <td contenteditable="true">{{ a.nombre }}</td>
                    <td contenteditable="true">{{ a.grado }}</td>
                    <td contenteditable="true">{{ a.grupo }}</td>
                    <td contenteditable="true">{{ a.nivel }}</td>
                    <td>{{ a.bloque.nombre if a.bloque else '‚Äî' }}</td>
                    <td class="acciones">
                        <button class="btn-accion guardar" title="Guardar cambios">üíæ</button>
                        <button class="btn-accion eliminar" title="Eliminar alumno">üóëÔ∏è</button>
                    </td>
                </tr>
                {% else %}
                <tr><td colspan="6" class="sin-datos">No hay alumnos registrados a√∫n.</td></tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="aviso">‚ö†Ô∏è No hay un ciclo activo. Activa un ciclo antes de importar alumnos.</p>
        {% endif %}
    </section>
</main>

<!-- üîπ Scripts -->
<script>
    // üí® Desvanecer mensajes autom√°ticamente
    setTimeout(() => {
        document.querySelectorAll('.flash').forEach(el => {
            el.style.opacity = '0';
            el.style.transform = 'translateY(-10px)';
            setTimeout(() => el.remove(), 600);
        });
    }, 3000);

    // üíæ Guardar cambios
    document.querySelectorAll(".guardar").forEach(btn => {
        btn.addEventListener("click", e => {
            const row = e.target.closest("tr");
            const id = row.dataset.id;
            const datos = {
                nombre: row.cells[0].innerText.trim(),
                grado: row.cells[1].innerText.trim(),
                grupo: row.cells[2].innerText.trim(),
                nivel: row.cells[3].innerText.trim()
            };
            fetch(`/admin/alumnos/editar/${id}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(datos)
            }).then(r => r.json()).then(res => {
                alert(res.message);
            });
        });
    });

    // üóëÔ∏è Eliminar alumno
    document.querySelectorAll(".eliminar").forEach(btn => {
        btn.addEventListener("click", e => {
            const row = e.target.closest("tr");
            const id = row.dataset.id;
            if (!confirm("¬øEliminar este alumno?")) return;
            fetch(`/admin/alumnos/eliminar/${id}`, { method: "DELETE" })
                .then(r => r.json())
                .then(res => {
                    alert(res.message);
                    row.remove();
                });
        });
    });
</script>
</body>
</html>
